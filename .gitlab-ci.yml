stages:
  - build     

install_dependencies:
  stage: build
  image: node:20
  image: reactnativecommunity/react-native-android
  before_script:
    - echo "Preparing Android environment..."
    - export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
    - echo "ðŸ“¦ Installing dependencies..."
    - npm ci
    - npm install -g firebase-tools
    - echo "âœ… Dependencies installed!"
  variables:
    RELEASE_KEY_ALIAS: $RELEASE_KEY_ALIAS
    RELEASE_STORE_PASSWORD: "${RELEASE_STORE_PASSWORD}"
    RELEASE_KEY_PASSWORD: "${RELEASE_KEY_PASSWORD}"
  script:
    - echo "ðŸ“¦ prettier checking..."
    - npm run prettier:check
    - echo "âœ… prettier checked!"
    - echo "ðŸ“¦ Running ESLint..."
    - npm run lint:fix
    - echo "âœ… ESLint done!"   
    - echo "ðŸ“¦ test checking..."
    - npm run test
    - echo "âœ… test checked!"
    - echo "ðŸ“¦ Building Android Release APK..."
    - export RELEASE_KEY_ALIAS="$RELEASE_KEY_ALIAS"
    - export RELEASE_STORE_PASSWORD="${RELEASE_STORE_PASSWORD}"
    - export RELEASE_KEY_PASSWORD="${RELEASE_KEY_PASSWORD}"
    - cd android
    - ./gradlew assembleRelease
    - echo "âœ… Release APK built!"
    - cd ..
    - echo "ðŸš€ Uploading APK to Firebase App Distribution..."
    - >
      firebase appdistribution:distribute android/app/build/outputs/apk/release/app-release.apk
      --app ${FIREBASE_APP_ID}
      --token ${FIREBASE_TOKEN}
      --groups "TESTERS_REELBOOK"
    - echo "âœ… APK uploaded to Firebase App Distribution!"      
